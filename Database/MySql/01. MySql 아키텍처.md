# MySql 아키텍처

![IMAGES](./images/mysql.JPG)

MySql 아키텍처는 크게 4가지로 구분할 수 있습니다.

- __MySql 접속 클라이언트__
  - MySQL Connectors
  - MySQL Shell
  - MySQL 은 대부분의 프로그래밍 언어에 대해 접속 API 를 제공한다. 그리고 Shell 에서도 Script 를 통해 MySQL 에 접속할 수 있다.
- __MySQL 엔진__ : MySQL 의 두뇌
  - 쿼리 파서
  - 전처리기
  - 옵티마이저
    - 요청된 SQL 문을 최적화하여 실행시키기 위해 실행 계획을 짜는 중요한 역할을 한다.
    - MySQL 엔진을 두뇌에 비유한 이유는 이 옵티마이저 때문이다.
  - 실행 엔진
- __MySQL 스토리지 엔진__
  - 스토리지 엔진은 데이터를 실제로 디스크에 저장하거나, 디스크에 저장된 데이터를 읽어오는 역할을 담당한다.
  - MySQL 엔진은 옵티마이저가 작성한 실행 계획에 따라서 스토리지 엔진을 적절히 호출해서 쿼리를 실행한다.
  - MySQL 엔진이 스토리지 엔진을 호출할 때 사용하는 API 를 `핸들러 API` 라고 한다.
  - 핸들러 API 를 직접 구현하여 나만의 스토리지 엔진을 추가할 수도 있다.
- __운영체제, 하드웨어__
  - 실제 테이블의 데이터와 로그 데이터를 파일로 저장하는 역할을 담당한다.

## 쿼리 실행 과정

![IMAGES](./images/opt.JPG)

- __쿼리 캐시(Query Cache)__
  - 클라이언트가 SQL 요청을 MySQL 로 보내면 가장 먼저 `쿼리 캐시(Query Cache)` 를 만난다.
  - SQL 실행 결과를 메모리에 캐싱하는 역할
  - 동일 SQL 실행시 이전 결과 즉시 반환
  - 테이블의 데이터가 변경되면 캐싱된 데이터 삭제 필요(동시 처리 성능 저하)
      - 더 이상 쓸모 없어지게 된 캐싱 데이터를 삭제할 때마다 쿼리 캐시에 접근하는 쓰레드에 Lock 이 걸리는데 이는 심각한 동시 처리 성능 저하를 유발한다.
  - Mysql 8.0 부터 완전히 제거됨
- __쿼리 파서(Query Parser)__
  - 쿼리 파서는 기본적인 SQL 문장 오류를 체크한다.
  - SQL 문장을 토큰으로 쪼개서 트리로 만듦
  - 쿼리 파서는 `Parse Tree` 를 만든다.
  
![IMAGES](./images/parsetree.JPG)

MySQL 은 이 Parse Tree 를 사용하여 쿼리를 실행한다.

- __전처리기(Preprocessor)__
  - 전처리기는 쿼리 파서가 만든 Parse Tree 를 기반으로 쿼리 문장에 구조적인 문제점이 있는지 검사한다.
  - Parse Tree 를 기반으로 SQL 문장 구조를 체크
  - Parse Tree 의 토큰을 하나씩 검사하면서, 토큰에 해당하는 테이블 이름이나 컬럼 등이 실제로 존재하는 값인지 체크하고, 접근 권한에 대해서도 체크한다.
- __옵티마이저(Optimizer)__
  - SQL 을 최적화해서 실행 계획을 수립한다.
  - `규칙 기반 최적화`
    - 옵티마이저에 내장된 우선순위에 따라 실행 계획 수립
  - `비용 기반 최적화`
    - 작업의 비용과 대상 테이블의 통계 정보를 활용해서 실행 계획 수립
- __쿼리 실행 엔진(Query Execution Engine)__
  - 옵티마이저가 만든 실행 계획대로 스토리지 엔진을 호출해서 쿼리를 실행하는 역할을 담당한다.
- __스토리지 엔진(Storage Engine)__
  - 쿼리 실행 엔진이 요청한대로, 데이터를 디스크에 저장하거나 디스크로부터 데이터를 읽어온다.
  - 핸들러 API 에 의해 동작
  - 핸들러라고도 불림
  - 플러그인 형태로 제공되기 때문에 사용자는 원하는 스토리지 엔진을 선택하여 사용할 수 있다.
    - 그 밖에도 검색어 파서, 사용자 인증 모듈 등의 플러그인도 존재 한다. 하지만 플러그인 끼리는 통신할 수 없다. 플러그인은 MySQL 서버의 변수나 함수를 직접 호출하기 때문에 캡슐화를 위반한다는 단점도 있다. 그래서 MySQL 8.0 부터는 이러한 플러그인 아키텍처를 보완한 `컴포넌트 아키텍처`를 제공하게 되었다.
  - 대표적으로 `InnoDB`, `MyISAM` 스토리지 엔진이 있다.

## InnoDB 스토리지 엔진

- __InnoDB 아키텍처__

![IMAGES](./images/innodb.JPG)

- __프라이머리 키(Primary Key)에 의한 클러스터링__
  - PK 순서대로 레코드를 디스크에 저장하는 것을 뜻한다.
  - PK 인덱스 자동 생성
    - PK 를 생성하지 않으면 InnoDB 가 알아서 생성해주는데, 이 생성된 PK 값을 사용자가 사용할 수 없으므로 직접 PK 를 생성해주는 것이 좋다.
  - PK 를 통해서만 레코드에 접근 가능
  - PK 를 통한 범위 검색이 매우 빠름
  - But 클러스터링 때문에 쓰기 성능 저하(일반적으로는 읽기가 더 중요하기 때문에 클러스터링 하는것이 합리적)
- __트랜잭션 지원__
  - InnoDB 는 기본적으로 Commit, Rollback 기능을 제공한다.
  - `MVCC(Multi Version Concurrency Control)` 기능도 제공한다.
- InnoDB 버퍼풀
  - InnoDB 버퍼풀은 변경된 데이터를 디스크에 반영하기 전까지 잠시 버퍼링하는 공간이다.
- __Undo Log__
  - 언두 로그(Undo Log)는 변경되기 이전 데이터를 백업 해두는 공간이다.
- Adaptive Hash Index

## References

> https://www.youtube.com/watch?v=vQFGBZemJLQ&list=PLgXGHBqgT2TvpJ_p9L_yZKPifgdBOzdVH&index=3
