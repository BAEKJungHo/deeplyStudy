# 쿠키

# 세션

사실 세션이라는 것이 뭔가 특별한 것이 아니라 단지 쿠키를 사용하는데, 서버에서 데이터를 유지하는 방법일 뿐이다.

- 세션 생성과 조회
  - 세션을 생성하려면 request.getSession(true) 를 사용하면 된다.
  - `public HttpSession getSession(boolean create);`

- request.getSession(true)
  - 세션이 있으면 기존 세션을 반환한다.
  - 세션이 없으면 새로운 세션을 생성해서 반환한다.
- request.getSession(false)
  - 세션이 있으면 기존 세션을 반환한다.
  - 세션이 없으면 새로운 세션을 생성하지 않는다. null 을 반환한다.
- request.getSession() : 신규 세션을 생성하는 request.getSession(true) 와 동일하다.

따라서, 위 개념을 적용하여 로그인 기능을 구현하면 아래와 같은 코드가 나온다.

```java
// 세션이 없으면 home
HttpSession session = request.getSession(false);
if (session == null) {
  return "home";
}

Member loginMember = (Member)session.getAttribute(SessionConst.LOGIN_MEMBER);
// 세션에 회원 데이터가 없으면 home
if (loginMember == null) {
  return "home";
}
```

스프링에서는 `@SessionAttribute` 라는 어노테이션을 이용하여 더 편리하게 쓸 수 있다.

- `@SessionAttribute`
  - 스프링은 세션을 더 편리하게 사용할 수 있도록 @SessionAttribute 을 지원한다.

이미 로그인 된 사용자를 찾을 때는 다음과 같이 사용하면 된다. 참고로 이 기능은 세션을 생성하지 않는다.

`@SessionAttribute(name = "loginMember", required = false) Member loginMember`

```java
 public String homeLoginV3Spring(
    @SessionAttribute(name = SessionConst.LOGIN_MEMBER, required = false) Member loginMember,
    Model model
 ) {
    // 세션에 회원 데이터가 없으면 home
    if (loginMember == null) {
        return "home";
    }

    // 세션이 유지되면 로그인으로 이동
    model.addAttribute("member", loginMember);
    return "loginHome";
}
```

세션을 찾고, 세션에 들어있는 데이터를 찾는 번거로운 과정을 스프링이 한번에 편리하게 처리해주는 것을 확인할 수 있다.

## 첫 로그인 시 jsessionid 가 URL 에 붙는 이유

서버 입장에서 웹 브라우저가 쿠키를 지원하는지 하지 않는지 최초에는 판단하지 못하므로, 쿠키 값도 전달하고, URL 에 `jessionid` 도 함께 전달한다.

URL 에 jessionid 를 붙여 전달하는 방식을 `URL 전달 방식`이라고 하는데, 이것은 웹 브라우저가 쿠키를 지원하지 않을 때 사용하는 방식이다.

URL 전달 방식을 끄고 항상 쿠키를 통해서만 세션을 유지하고 싶으면 스프링의 경우 `tracking-modes` 를 추가해주면 된다.

- application.properties

```yml
server.servlet.session.tracking-modes=cookie
```

# 쿠키와 세션 사용 시 주의 점

__클라이언트와 서버는 결국 쿠키로 연결이 되어야 한다.__

- 쿠키는 웹 브라우저에서 쉽게 정보를 변경할 수 있어서, 클라이언트 해킹 시 정보가 쉽게 노출될 수 있기 때문에 중요한 정보를 담아서는 안 된다.
- 세션은 정보를 서버에 저장하고 클라이언트에는 JSESSIONID 라는 쿠키 값만 넘겨 사용하기 때문에 쿠키만 사용했을 때보다는 안전 하지만, 그래도 세션에 정보를 담을 때, 중요한 정보는 암호화해서 담아야한다. `세션 하이재킹`이라는 기술이 있기 때문에 세션도 해킹 당할 수 있다.
  - 세션에는 가급적 필요한 정보들만 추려서 담아야 한다.
  - 세션에 담긴 객체를 꺼내어 그 객체의 값을 변경 시킨다던지의 행동은 하지 말아야 한다.

- 세션에 담긴 객체 꺼내서 값 변경 금지

```java
HttpSession session = request.getSession(false); // 세션을 찾아서 사용하는 시점에는 false 를 주어서 세션을 생성하지 않아야 한다.
LoginUser user = (LoginUser) session.getAttribute(LOGIN_SESSION_ID);
user.setId("abc"); // 바꾸는 순간 세션에 들어있는 로그인 아이디가 변경 된다. 따라서 이러한 코드는 짜지 말아야 한다.
```

# 자동 로그인 구현 방법

스프링 시큐리티의 `remember-me` 는 자동 로그인을 구현할 수 있게 해주는데, 특징은 `세션과 쿠키`를 이용한다는 것이다.

세션은 브라우저 소멸시 같이 소멸되기 때문에, 자동 로그인을 구현하기 위해서는 쿠키를 이용해서 유효기간을 설정해줘야 한다.

로그인에 성공했을 때 사용자 DB 테이블에 sessionId 와 유효기간 컬럼에 값을 지정하는 것이다. 그리고 쿠키에는 sessionId 를 넣어 놓는다.

그리고 인터셉터(interceptor) 에서 해당 쿠키값이 존재하면 사용자 DB 테이블 내에서 유효시간 > now() 즉, 유효시간이 아직 남아 있으면서 해당 세션 Id를 가지고 있는 사용자 정보를 검색해 해당 사용자 객체를 반환하는 것이다.

이후, AuthenticationInterceptor의 preHandle() 부분에서

세션에 UserVO 객체가 null 이 아닌 경우는 로그인 되어 있는 부분이니까 그대로 처리되도록 놔두고, 세션의 UserVO 객체가 null 이지만, 쿠키가 null 이 아닌 경우 쿠키에서 sessionId 를 꺼내와서 사용자 객체를 반환받도록 작업해야한다.

인터셉터랑, 로그인 처리하는 컨트롤러 부분에서는 로그인 하고 나면 최종 접속일을 수정해야한다.
